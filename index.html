<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grammar Checker</title>
<style>
  body {
    background-color: #000;
    color: #00ff00;
    font-family: 'Courier New', Courier, monospace;
    margin: 0; padding: 1em;
  }
  textarea {
    width: 100%;
    height: 150px;
    background: #000;
    color: #00ff00;
    border: 1px solid #00ff00;
    font-family: inherit;
    font-size: 1.2em;
    padding: 0.5em;
    box-sizing: border-box;
    outline-offset: 4px;
    outline-color: #00ff00;
  }
  textarea:focus {
    outline-style: solid;
    outline-width: 2px;
  }
  button {
    background: #000;
    border: 1px solid #00ff00;
    color: #00ff00;
    font-family: inherit;
    font-size: 1em;
    padding: 0.5em 1em;
    margin: 0.5em 0.5em 1em 0;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover, button:focus {
    background: #002200;
    outline: none;
  }
  .issue {
    border: 1px solid #00ff00;
    padding: 0.5em;
    margin-bottom: 0.5em;
    border-radius: 3px;
  }
  .issue strong.highlight {
    color: #0f0;
  }
  .error {
    color: #f00;
  }
  #log, #debug {
    background: #001100;
    color: #0f0;
    font-size: 0.9em;
    height: 150px;
    overflow-y: auto;
    padding: 0.5em;
    border: 1px solid #00ff00;
    margin-top: 1em;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
<h1>Grammar Checker</h1>
<textarea id="textInput" aria-label="Input text to check grammar"></textarea><br />
<button id="checkBtn" aria-label="Check grammar">Check Grammar</button>
<button id="autoBtn" aria-label="Auto-correct grammar">Auto-Correct</button>

<div id="suggestions" aria-live="polite" aria-atomic="true"></div>

<h2>Developer Log</h2>
<div id="log"></div>
<h2>Debug Info</h2>
<div id="debug"></div>

<script>
  const textInput = document.getElementById('textInput');
  const checkBtn = document.getElementById('checkBtn');
  const autoBtn = document.getElementById('autoBtn');
  const suggestionsEl = document.getElementById('suggestions');
  const logLines = document.getElementById('log');
  const debugLines = document.getElementById('debug');

  // Common simple mistakes dictionary for auto-correct
  const commonMistakes = {
    // spelling errors
    'teh': 'the',
    'recieve': 'receive',
    'definately': 'definitely',
    'seperate': 'separate',
    'occured': 'occurred',
    'untill': 'until',
    'alot': 'a lot',
    'wich': 'which',
    'adress': 'address',
    'becuase': 'because',
    'thier': 'their',
    'freind': 'friend',
    'wierd': 'weird',
    'beleive': 'believe',
    'tommorow': 'tomorrow',
    'acheive': 'achieve',
    'realy': 'really',
    'truely': 'truly',
    // common contractions
    'dont': "don't",
    'cant': "can't",
    'wont': "won't",
    'shouldnt': "shouldn't",
    'couldnt': "couldn't",
    'wouldnt': "wouldn't",
    'im': "I'm",
    'ive': "I've",
    'id': "I'd",
    'youre': "you're",
    // confusion words
    'your': "your (possessive) or you're (you are)?",
    // Add more as needed
  };

  // Simple verb agreement check pairs (existing)
  // Note: We'll extend this below
  const verbAgreementMistakes = {
    'he are': 'he is',
    'she are': 'she is',
    'it are': 'it is',
    'there is are': 'there are',
  };

  // Additional pronouns and correct present/past forms (for new rules)
  const pronounVerbAgreement = {
    // Present tense singular
    'i': { 'be': 'am', 'have': 'have' },
    'you': { 'be': 'are', 'have': 'have' },
    'he': { 'be': 'is', 'have': 'has' },
    'she': { 'be': 'is', 'have': 'has' },
    'it': { 'be': 'is', 'have': 'has' },

    // Plural pronouns - 'be' and 'have' are 'are' and 'have'
    'we': { 'be': 'are', 'have': 'have' },
    'they': { 'be': 'are', 'have': 'have' },
  };

  // Helper to check if a word is a pronoun we handle
  function isPronoun(word) {
    return Object.keys(pronounVerbAgreement).includes(word.toLowerCase());
  }

  // Helper to check verb correctness for simple present tense 'to be' and 'to have'
  // Returns {correctForm, isCorrect} or null if not applicable
  function checkPronounVerbAgreement(pronoun, verb) {
    pronoun = pronoun.toLowerCase();
    verb = verb.toLowerCase();
    if (!isPronoun(pronoun)) return null;
    // For 'to be' forms like am/is/are
    if (['am', 'is', 'are', 'be'].includes(verb)) {
      const correctForm = pronounVerbAgreement[pronoun]['be'];
      return {correctForm, isCorrect: (verb === correctForm)};
    }
    // For 'to have' forms like have/has
    if (['have', 'has'].includes(verb)) {
      const correctForm = pronounVerbAgreement[pronoun]['have'];
      return {correctForm, isCorrect: (verb === correctForm)};
    }
    return null;
  }

  // Basic present tense verb singular/plural check for -s endings
  // He walks (correct), They walk (correct), He walk (wrong)
  // Return correction suggestion or null if correct
  function checkSimpleVerbAgreement(subject, verb) {
    subject = subject.toLowerCase();
    verb = verb.toLowerCase();

    // Pronouns that require singular verb with -s in present tense
    const singularSubjects = ['he', 'she', 'it'];

    // Pronouns that require plural verb (no -s)
    const pluralSubjects = ['i', 'you', 'we', 'they'];

    // We'll only check for simple verbs that end or don't end with 's'
    // Skip auxiliary verbs or irregular verbs (basic approach)
    // Check if verb ends with 's' or not
    const verbEndsWithS = verb.endsWith('s');

    if (singularSubjects.includes(subject)) {
      // Singular subject requires verb with 's'
      if (!verbEndsWithS) {
        // Likely should have 's'
        // Exception: 'be', 'have' handled earlier
        if (['be', 'have', 'am', 'is', 'are', 'has'].includes(verb)) return null;
        return verb + 's';
      }
    } else if (pluralSubjects.includes(subject)) {
      // Plural subject requires verb without 's'
      if (verbEndsWithS) {
        // Remove trailing s (naive)
        // Exception: verbs ending with 'ss' etc. ignored for simplicity
        if (verb.length > 3) { // prevent too short verbs
          return verb.slice(0, -1);
        }
      }
    }
    return null; // no suggestion needed
  }

  // Basic past tense check (simple heuristic)
  // For verbs that incorrectly use base form instead of past tense
  // Example: "He walk yesterday" → "He walked yesterday"
  // We'll check verbs following past time words like "yesterday", "last"
  // This is very simplistic
  const commonRegularVerbs = ['walk', 'talk', 'play', 'work', 'jump', 'look', 'call', 'live', 'love'];
  function checkPastTense(sentenceTokens) {
    // Check for 'yesterday' or 'last' + noun + base verb pattern
    // Return list of issues with suggested corrections
    const issues = [];
    for (let i = 0; i < sentenceTokens.length; i++) {
      const word = sentenceTokens[i].toLowerCase();
      if (word === 'yesterday' || word === 'last') {
        // Look ahead 1 or 2 tokens for base verb (naive)
        if (i + 2 < sentenceTokens.length) {
          const possibleVerb = sentenceTokens[i + 2].toLowerCase();
          // If it's a common regular verb and no -ed ending, suggest adding -ed
          if (commonRegularVerbs.includes(possibleVerb)) {
            issues.push({
              type: 'Past tense',
              word: possibleVerb,
              index: i + 2,
              suggestion: `Consider using past tense "${possibleVerb}ed" instead of "${possibleVerb}".`
            });
          }
        }
      }
    }
    return issues;
  }

  // Helper log function for dev panel
  function log(message) {
    const line = document.createElement('div');
    line.textContent = `[LOG] ${message}`;
    logLines.appendChild(line);
    logLines.scrollTop = logLines.scrollHeight;
  }

  // Debug info update
  function debug(message) {
    const line = document.createElement('div');
    line.textContent = message;
    debugLines.appendChild(line);
    debugLines.scrollTop = debugLines.scrollHeight;
  }

  // Clear logs/debug info
  function clearLogs() {
    logLines.innerHTML = '';
    debugLines.innerHTML = '';
  }

  // Tokenize text to words, punctuation kept separate
  function tokenize(text) {
    // Regex splits words and punctuation but keeps contractions as one token
    return text.match(/[\w']+|[.,!?;:"()\-]/g) || [];
  }

  // Check for repeated words
  function findRepeatedWords(tokens) {
    const issues = [];
    for (let i = 1; i < tokens.length; i++) {
      const curr = tokens[i].toLowerCase();
      const prev = tokens[i-1].toLowerCase();
      if (curr === prev && /^[a-z']+$/.test(curr)) {
        issues.push({
          type: 'Repeated word',
          word: curr,
          index: i,
          suggestion: `Remove one occurrence of "${curr}".`
        });
      }
    }
    return issues;
  }

  // Check for common mistakes and gather suggestions
  function findCommonMistakes(tokens) {
    const issues = [];
    tokens.forEach((token, idx) => {
      const lower = token.toLowerCase();
      if (commonMistakes.hasOwnProperty(lower)) {
        issues.push({
          type: 'Common mistake',
          word: token,
          index: idx,
          suggestion: `Consider replacing "${token}" with "${commonMistakes[lower]}".`
        });
      }
    });
    return issues;
  }

  // Check for verb agreement mistakes (extended)
  function findVerbAgreementMistakes(text) {
    const issues = [];
    const tokens = tokenize(text);

    // Existing phrase replacements
    for (const [wrongPhrase, correctPhrase] of Object.entries(verbAgreementMistakes)) {
      const regex = new RegExp(`\\b${wrongPhrase}\\b`, 'gi');
      let match;
      while ((match = regex.exec(text)) !== null) {
        issues.push({
          type: 'Verb agreement',
          phrase: match[0],
          index: match.index,
          suggestion: `Use "${correctPhrase}" instead of "${match[0]}".`
        });
      }
    }

    // New: check pronoun + verb pairs for 'to be' and 'to have'
    for (let i = 0; i < tokens.length - 1; i++) {
      const w1 = tokens[i];
      const w2 = tokens[i + 1];
      // Check only alphabetic tokens for subject and verb
      if (!/^[a-zA-Z']+$/.test(w1) || !/^[a-zA-Z']+$/.test(w2)) continue;
      const agreement = checkPronounVerbAgreement(w1, w2);
      if (agreement && !agreement.isCorrect) {
        issues.push({
          type: 'Verb agreement',
          phrase: w1 + ' ' + w2,
          index: i,
          suggestion: `Use "${w1} ${agreement.correctForm}" instead of "${w1} ${w2}".`
        });
      }

      // Check simple present tense verb agreement (he walk → he walks)
      const simpleVerbCorrection = checkSimpleVerbAgreement(w1, w2);
      if (simpleVerbCorrection) {
        issues.push({
          type: 'Verb agreement',
          phrase: w1 + ' ' + w2,
          index: i,
          suggestion: `Use "${w1} ${simpleVerbCorrection}" instead of "${w1} ${w2}".`
        });
      }
    }

    return issues;
  }

  // Aggregate all grammar issues
  function findGrammarIssues(text) {
    clearLogs();
    const tokens = tokenize(text);
    const issues = [
      ...findRepeatedWords(tokens),
      ...findCommonMistakes(tokens),
      ...findVerbAgreementMistakes(text),
      ...checkPastTense(tokens)
    ];
    log(`Found ${issues.length} issues.`);
    return issues;
  }

  // Display issues nicely
  function displayIssues(issues) {
    if (issues.length === 0) {
      suggestionsEl.innerHTML = '<p>No issues found. Your text looks good!</p>';
      return;
    }
    const html = issues.map(issue => {
      if(issue.word) {
        return `<div class="issue"><strong class="highlight">${issue.word}</strong> - <em>${issue.type}</em><br />Suggestion: ${issue.suggestion}</div>`;
      }
      if(issue.phrase) {
        return `<div class="issue"><strong class="highlight">${issue.phrase}</strong> - <em>${issue.type}</em><br />Suggestion: ${issue.suggestion}</div>`;
      }
      return `<div class="issue"><em>${issue.type}</em><br />Suggestion: ${issue.suggestion}</div>`;
    }).join('');
    suggestionsEl.innerHTML = html;
  }

  // Auto-correct text based on our issues (simple approach)
  // We'll fix commonMistakes, repeated words, and verb agreement of 'to be' and 'to have' and simple s-ending verbs
  function autoCorrectText(text) {
    let tokens = tokenize(text);
    let changed = false;

    // Fix common mistakes
    tokens = tokens.map(token => {
      const lower = token.toLowerCase();
      if (commonMistakes.hasOwnProperty(lower)) {
        changed = true;
        // Keep original capitalization
        if (token[0] === token[0].toUpperCase()) {
          // Capitalize suggestion
          return commonMistakes[lower].charAt(0).toUpperCase() + commonMistakes[lower].slice(1);
        }
        return commonMistakes[lower];
      }
      return token;
    });

    // Remove repeated words
    for (let i = 1; i < tokens.length; i++) {
      if (tokens[i].toLowerCase() === tokens[i - 1].toLowerCase() && /^[a-z']+$/.test(tokens[i].toLowerCase())) {
        tokens.splice(i, 1);
        changed = true;
        i--;
      }
    }

    // Fix verb agreement for pronouns + to be/have
    for (let i = 0; i < tokens.length - 1; i++) {
      const w1 = tokens[i];
      const w2 = tokens[i + 1];
      if (!/^[a-zA-Z']+$/.test(w1) || !/^[a-zA-Z']+$/.test(w2)) continue;
      const agreement = checkPronounVerbAgreement(w1, w2);
      if (agreement && !agreement.isCorrect) {
        tokens[i + 1] = agreement.correctForm;
        changed = true;
      } else {
        // Check simple present verb agreement
        const verbCorrection = checkSimpleVerbAgreement(w1, w2);
        if (verbCorrection) {
          tokens[i + 1] = verbCorrection;
          changed = true;
        }
      }
    }

    // Join tokens back to string (attempt to keep spacing correct)
    // We'll add space except before punctuation characters
    const punctuation = new Set(['.', ',', '!', '?', ';', ':', '"', "'", ')', '(', '-']);
    let result = '';
    for (let i = 0; i < tokens.length; i++) {
      if (i > 0 && !punctuation.has(tokens[i]) && !punctuation.has(tokens[i - 1])) {
        result += ' ';
      }
      result += tokens[i];
    }

    if (!changed) return null;
    return result;
  }

  checkBtn.addEventListener('click', () => {
    const text = textInput.value;
    const issues = findGrammarIssues(text);
    displayIssues(issues);
  });

  autoBtn.addEventListener('click', () => {
    const text = textInput.value;
    const corrected = autoCorrectText(text);
    if (corrected === null) {
      suggestionsEl.innerHTML = '<p>No automatic corrections suggested.</p>';
    } else {
      suggestionsEl.innerHTML = '<p><strong>Auto-corrected text:</strong></p><textarea style="width:100%;height:150px;">' + corrected + '</textarea>';
      textInput.value = corrected;
    }
  });
</script>
</body>
</html>
